# Проект 1
Задача — построить витрину для RFM-классификации. Для анализа нужно отобрать только успешно выполненные заказы (со статусом 4 - "Closed").

-------
1. Описание сбора витрины.
  Для сбора витрины объединили таблицы users и orders по идентификатору пользователя с условиями: заказ закрыт (статус 4), дата начиная с 1 января 2021 года.
  Поля для сбора витрины: users.user_id, orders.order_ts, orders.payment.
  Затем с помощью CTE распределили пользователей по группам на основе метрик и вставили все данные в витрину analysis.dm_rfm_segments.

2. Анализ качества данных схемы production.
  Схема production состоит из следующих таблиц:
    - orderitems -- в таблице хранятся все заказанные товары, с их ценой, количеством и скидкой в заказе; ограничения: все поля NOT NULL, цена, скидка количество всегда больше 0, уникальное сочетание идентификаторов продукта product_id и заказа order_id (в одном заказе не может быть двух одинаковых продуктов); типы данных верные
    - orders -- в таблице хранится информация обо всех заказах, их стоимости и последнем статусе; ограничения: все поля NOT NULL, итоговая стоимость заказа (cost) = оплаченная сумма (payment) + сумма списанных бонусов (bonus_payment); типы данных верные
    - orderstatuses -- словарь статусов заказа, ограничения: все поля NOT NULL; типы данных верные
    - orderstatuslog -- логи статусов заказов; ограничения: все поля NOT NULL, уникальное сочетание идентификаторов заказа order_id и статуса status_id (один заказ получает один статус только один раз), FK на полях order_id (поле order_id из таблицы orders) и status_id (поле status_id из таблицы orderstatuses); типы данных верные
    - products -- список доступных товаров; ограничения: все поля NOT NULL, цена товара всегда больше 0; типы данных верные
    - users -- список пользователей; ограничения: поле name по умолчанию NULL, все остальные поля NOT NULL; типы данных верные


Для построения витрины использованы данные из таблицы orders и данные по пользователям из таблицы users (обе в схеме production).
Не все пользователи хоть раз совершали заказ с 2021 года, поэтому в расчётах показателей таблицы соединяются left join по идентификатору пользователя.

С помощью нескольких CTE вычисляем необходимые данные для расчёта метрик и кластеризации пользователей (подробная информация в комментариях в скрипте).

Всего в таблице users 1000 пользователей, по каждой метрике равное количество (200 чел.) пользователей в каждом сегменте (от 1 до 5).

Итоговая витрина в виде таблицы, так как обновления витрины не предусмотрены.


