# Проект 4

Задача — реализовать витрину для расчётов с курьерами - рассчитать суммы оплаты каждому курьеру за месяц.

### Состав витрины:


**_id_** — идентификатор записи.    
**_courier_id_** — ID курьера, которому перечисляем.  
**_courier_name_** — Ф. И. О. курьера.  
**_settlement_year_** — год отчёта.  
**_settlement_month_** — месяц отчёта, где 1 — январь и 12 — декабрь.  
**_orders_count_** — количество заказов за период (месяц).  
**_orders_total_sum_** — общая стоимость заказов.  
**_rate_avg_** — средний рейтинг курьера по оценкам пользователей.  
**_order_processing_fee_** — сумма, удержанная компанией за обработку заказов, которая высчитывается как orders_total_sum * 0.25.  
**_courier_order_sum_** — сумма, которую необходимо перечислить курьеру за доставленные им/ей заказы. За каждый доставленный заказ курьер должен получить некоторую сумму в зависимости от рейтинга (см. ниже).  
**_courier_tips_sum_** — сумма, которую пользователи оставили курьеру в качестве чаевых.  
**_courier_reward_sum_** — сумма, которую необходимо перечислить курьеру. Вычисляется как courier_order_sum + courier_tips_sum * 0.95 (5% — комиссия за обработку платежа).  

Правила расчёта процента выплаты курьеру в зависимости от рейтинга, где r — это средний рейтинг курьера в текущем месяце:


**r < 4** — 5% от заказа, но не менее 100 руб.;  
**4 <= r < 4.5** — 7% от заказа, но не менее 150 руб.;  
**4.5 <= r < 4.9** — 8% от заказа, но не менее 175 руб.;  
**4.9 <= r** — 10% от заказа, но не менее 200 руб.  

Данные о доставленных заказов загружаются из API курьерской службы.


### Содержание данных в источниках:


* restaurants - данные о ресторанах  
	**__id_** — идентификатор  
	**_name_** — название ресторана  

* couriers - данные о курьерах  
	**__id_** — идентификатор курьера  
	**_name_** — имя  

* deliveries - данные о завершённых доставках  
	**_order_id_** — идентификатор заказа  
	**_order_ts_** — дата, время заказа  
	**_delivery_id_** — идентификатор доставки  
	**_courier_id_** — идентификатор курьера  
	**_address_** — адрес доставки  
	**_delivery_ts_** — дата, время доставки  
	**_rate_** — оценка, выставленная клиентом курьеру  
	**_sum_** — сумма заказа  
	**_tip_sum_** — сумма чаевых, оставленных курьеру  

### Реализация DWH

Хранилище состоит из трёх слоёв: STG, DDS, CDM.
Данные в DDS хранятся по схеме звезда.
Обновление данных: при конфликтах уникальных значений данные обновляются.  
![Схема слоя DDS](https://github.com/pmkhlv/de-project-4/blob/main/dds_data_model.png)

### Реализация ETL
Процесс загрузки данных из API в staging-слой системы реализован с помощью DAG-оркестратора Airflow на языке программирования Python. 

Порядок загрузки данных STG -> DDS -> CDM.
![DAG Graph](https://github.com/pmkhlv/de-project-4/blob/main/airflow_graph.png)


При повторной загрузке данных в слой STG данные из источников restaurants и couriers полностью обновляются по SCD1.

Периодичность обновления не предусмотрена требованиями к витрине.
